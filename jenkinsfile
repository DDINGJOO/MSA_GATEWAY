pipeline {
  agent any   // 어떤 노드에서나 실행

  environment {
    IMAGE_NAME = 'msa-gateway'   // 만들어질 Docker 이미지 이름
    CONTAINER_NAME = 'msa-gateway'  // 띄울 컨테이너 이름
    CONTAINER_PORT = '9500'     // 사용할 포트
  }

  stages {
    stage('Clone Repository') {
      steps {
        git branch: 'main', url: 'https://github.com/https://github.com/DDINGJOO/MSA_GATEWAY.git'
      }
    }

    stage('Build Docker Image') {
      steps {
        sh "docker build -t ${IMAGE_NAME} ."
      }
    }

    stage('Stop & Remove Old Container') {
      steps {
        sh """
          docker stop ${CONTAINER_NAME} || true
          docker rm ${CONTAINER_NAME} || true
        """
      }
    }

    stage('Run New Container') {
      steps {
        sh """
          docker run -d --name ${CONTAINER_NAME} -p ${CONTAINER_PORT}:${CONTAINER_PORT} ${IMAGE_NAME}
        """
      }
    }
  }

  triggers {
    githubPush()
  }
}
